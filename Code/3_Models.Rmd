---
title: "3_Models"
output: pdf_document
---

```{r}

library(ggplot2)
library(dplyr)
library(tidyr)
library(readr)
library(sf)
library(tigris)
library(plm)
library(lmtest)
library(lme4)
library(glmnet)

data <- readRDS("../Data/Processed/Merged_Data.rds")

# Understand how the relationship between demographic composition and Democratic vote share has changed over time — both in terms of correlation strength and model-based explanatory power.

# Fit two models, one on first half of years and other on last half of years

```

```{r}

# Split into train and test sets (70/30 split)

test_years <- c(1972, 1976, 2016, 2020)
test <- data[data$election_year %in% test_years, ]
train <- data[!(data$election_year %in% test_years), ]

```

```{r}

# Perform Lasso (with CV)

set.seed(123)

# Set up matrices
y <- train$dem_vote_share_two_party
X <- model.matrix(dem_vote_share_two_party ~ White_Total_Pop + Black_Total_Pop + Other_Total_Pop + Male_Total_Pop + Female_Total_Pop + Age_0_Total_Pop + Age_1_Total_Pop + Age_2_Total_Pop + Age_3_Total_Pop + Age_4_Total_Pop + Age_5_Total_Pop + Female_Black_0 + Female_Black_1 + Female_Black_2 + Female_Black_3 + Female_Black_4 + Female_Black_5 + Female_Other_0 + Female_Other_1 + Female_Other_2 + Female_Other_3 + Female_Other_4 + Female_Other_5 + Female_White_0 + Female_White_1 + Female_White_2 + Female_White_3 + Female_White_4 + Female_White_5 + Male_Black_0 + Male_Black_1 + Male_Black_2 + Male_Black_3 + Male_Black_4 + Male_Black_5 + Male_Other_0 + Male_Other_1 + Male_Other_2 + Male_Other_3 + Male_Other_4 + Male_Other_5 + Male_White_0 + Male_White_1 + Male_White_2 + Male_White_3 + Male_White_4 + Male_White_5 + Total_Pop + factor(election_year), data = train)[,-1]

# Perform cross-validation
cv_lasso <- cv.glmnet(X, y, alpha = 1, standardize = TRUE, nfolds = 10)
plot(cv_lasso)

# Extract coefficients based on lambda with lowest CV error
optimal_lambda <- cv_lasso$lambda.min # Lambda with lowest CV error
lasso_coef <- coef(cv_lasso, s = "lambda.min")

# Only choose coefficients with abs coefficient value > 0.05
threshold <- 0.05
selected_vars <- rownames(lasso_coef)[abs(lasso_coef[, 1]) >= threshold & rownames(lasso_coef) != "(Intercept)"]

# Print in order
selected_coef_values <- lasso_coef[selected_vars, , drop = FALSE]
coef_vector <- as.numeric(selected_coef_values)
names(coef_vector) <- rownames(selected_coef_values)

sorted_coef <- sort(coef_vector, decreasing = TRUE, index.return = TRUE)
sorted_coef_named <- coef_vector[order(coef_vector, decreasing = TRUE)]

# Convert to data frame
coef_df <- data.frame(
  Variable = names(sorted_coef_named),
  Coefficient = sorted_coef_named
)

print(coef_df)

```


```{r}

# summary(fe_model)$r.squared
# library(fixest)
# fe_model <- feols(dem_vote_share_two_party ~ female_share + white_share + black_share + age0_share + age5_share | county + election_year, data = your_data)
# Lsummary(fe_model)

pdata_train <- pdata.frame(train, index = c("fips", "election_year")) # Convert to panel data
model <- dem_vote_share_two_party ~ Male_Other_2 + Male_Other_4 + Female_Other_1 + Female_Black_4 + Female_Black_3 + Male_Other_3 + Female_Other_4 + Male_Black_2 + Female_White_3 + Male_Black_5 + Male_Black_1 + Female_Other_2 + Male_White_2 + Male_Other_1 + Female_Black_0 + Male_Black_0 + Female_Other_5 + Female_White_5 + Female_White_4 + as.numeric(election_year)

fe_model <- plm(model, data = pdata_train, model = "within")
re_model <- plm(model, data = pdata_train, model = "random")
ols_model <- plm(model, data = pdata_train, model = "pooling")

# Hausman Test (Fixed vs. Random Effects)
hausman_test <- phtest(fe_model, re_model) # Prefer fixed effects
print(hausman_test)

# Breusch-Pagan Lagrange Multiplier Test (Random Effects vs. OLS)
bp_lm_test <- plmtest(ols_model, type = "bp") # Prefer random effects
print(bp_lm_test)

# F-Test (Fixed Effects vs. OLS)
f_test <- pFtest(fe_model, ols_model) # Prefer fixed effects
print(f_test)

# Wald Test (Nested F-Test)
fe_no_time_model <- plm(dem_vote_share_two_party ~ Male_Other_2 + Male_Other_4 + Female_Other_1 + Female_Black_4 + Female_Black_3 + Male_Other_3 + Female_Other_4 + Male_Black_2 + Female_White_3 + Male_Black_5 + Male_Black_1 + Female_Other_2 + Male_White_2 + Male_Other_1 + Female_Black_0 + Male_Black_0 + Female_Other_5 + Female_White_5 + Female_White_4, data = pdata_train, model = "within")

wald_test <- waldtest(fe_no_time_model, fe_model) # Prefer model with factor(election_year)
print(wald_test)

```






```{r}

# Pooled OLS

lm_fixed_base <- lm(dem_vote_share_two_party ~ White_Total_Pop + Black_Total_Pop + Other_Total_Pop + Male_Total_Pop + Female_Total_Pop + Age_0_Total_Pop + Age_1_Total_Pop + Age_2_Total_Pop + Age_3_Total_Pop + Age_4_Total_Pop + Age_5_Total_Pop + factor(election_year), data = data)

lm_fixed_sliced <- lm(dem_vote_share_two_party ~ Female_Black_0 + Female_Black_1 + Female_Black_2 + Female_Black_3 + Female_Black_4 + Female_Black_5 + Female_Other_0 + Female_Other_1 + Female_Other_2 + Female_Other_3 + Female_Other_4 + Female_Other_5 + Female_White_0 + Female_White_1 + Female_White_2 + Female_White_3 + Female_White_4 + Female_White_5 + Male_Black_0 + Male_Black_1 + Male_Black_2 + Male_Black_3 + Male_Black_4 + Male_Black_5 + Male_Other_0 + Male_Other_1 + Male_Other_2 + Male_Other_3 + Male_Other_4 + Male_Other_5 + Male_White_0 + Male_White_1 + Male_White_2 + Male_White_3 + Male_White_4 + Male_White_5 + factor(election_year), data = data)

lm_fixed_total <- lm(dem_vote_share_two_party ~ White_Total_Pop + Black_Total_Pop + Other_Total_Pop + Male_Total_Pop + Female_Total_Pop + Age_0_Total_Pop + Age_1_Total_Pop + Age_2_Total_Pop + Age_3_Total_Pop + Age_4_Total_Pop + Age_5_Total_Pop + Female_Black_0 + Female_Black_1 + Female_Black_2 + Female_Black_3 + Female_Black_4 + Female_Black_5 + Female_Other_0 + Female_Other_1 + Female_Other_2 + Female_Other_3 + Female_Other_4 + Female_Other_5 + Female_White_0 + Female_White_1 + Female_White_2 + Female_White_3 + Female_White_4 + Female_White_5 + Male_Black_0 + Male_Black_1 + Male_Black_2 + Male_Black_3 + Male_Black_4 + Male_Black_5 + Male_Other_0 + Male_Other_1 + Male_Other_2 + Male_Other_3 + Male_Other_4 + Male_Other_5 + Male_White_0 + Male_White_1 + Male_White_2 + Male_White_3 + Male_White_4 + Male_White_5 + factor(election_year), data = data)

summary(lm_fixed_sliced)


```

```{r}

# Random effects
# Random intercept: lmer(dem_vote_share_two_party ~ demographics + (1 | county), data = your_data)
# Random intercpet & slope: lmer(dem_vote_share_two_party ~ year + demographics + (year | county), data = your_data)



```

```{r}

# Two-way fixed effects
# lm(dem_vote_share_two_party ~ demographics + factor(county) + factor(year), data = your_data)


```


```{r}

print(unique(data$election_year)) # 13 elections
test_years <- c(1972, 1976, 2016, 2020)

not_model_columns <- c("county_name", "state", "sfips", "office", "election_type", "seat_status", "democratic_raw_votes", "dem_nominee", "republican_raw_votes", "rep_nominee", "pres_raw_county_vote_totals_two_party", "raw_county_vote_totals", "dem_vote_share_total", "rep_vote_share_total", "dem_voter_turnout", "rep_voter_turnout", "total_voter_turnout", "complete_county_cases", "Total_Pop")

data_model <- data %>% 
  select(-not_model_columns)

test <- data[data$election_year %in% test_years, ]
train <- data[!(data$election_year %in% test_years), ]

colnames(data)

```

```{r}

lm_model <- lm(dem_vote_share_two_party ~ ., data = train)

# Predict on test set
test$predicted <- predict(model, newdata = test)

# Compute R² for each year
r2_by_year <- test %>%
  group_by(election_year) %>%
  summarise(
    R2 = cor(dem_vote_share, predicted)^2
  )

```