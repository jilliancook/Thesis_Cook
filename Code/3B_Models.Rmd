---
title: "3B_Models"
output: pdf_document
---

```{r}

library(ggplot2)
library(dplyr)
library(tidyr)
library(readr)
library(sf)
library(tigris)
library(plm)
library(lmtest)
library(lme4)
library(glmnet)
library(kableExtra)

```

```{r}

# BUILDING TRAIN & TEST (70/30)

data <- readRDS("../Data/Processed/Merged_Data.rds")
model_data <- data %>% 
  select(election_year, fips, dem_vote_share_two_party, Female_Total_Pop, Male_Total_Pop, White_Total_Pop, Black_Total_Pop, Other_Total_Pop, Age_0_Total_Pop, Age_1_Total_Pop, Age_2_Total_Pop, Age_3_Total_Pop, Age_4_Total_Pop, Age_5_Total_Pop)

train <- model_data[!(model_data$election_year %in% c(1972, 1976, 2016, 2020)), ]
test_early <- model_data[model_data$election_year %in% c(1972, 1976), ]
test_late <- model_data[model_data$election_year %in% c(2016, 2020), ]

data <- pdata.frame(model_data, index = c("fips", "election_year"))
pdata_train <- pdata.frame(train, index = c("fips", "election_year"))
pdata_test_early <- pdata.frame(test_early, index = c("fips", "election_year"))
pdata_test_late <- pdata.frame(test_late, index = c("fips", "election_year"))

```

```{r}

# MODEL SEQUENCE: BASE MODELS

# M0: Intercept Only (OLS)
m_int <- plm(dem_vote_share_two_party ~ 1, data = pdata_train, model = "pooling")

# M1A: Age Only (OLS)
m_age <- plm(dem_vote_share_two_party ~ Age_0_Total_Pop + Age_1_Total_Pop + Age_2_Total_Pop + Age_4_Total_Pop + Age_5_Total_Pop, data = pdata_train, model = "pooling")

# M1B: Sex Only (OLS)
m_sex <- plm(dem_vote_share_two_party ~ Female_Total_Pop, data = pdata_train, model = "pooling")

# M1C: Race Only (OLS)
m_race <- plm(dem_vote_share_two_party ~ Black_Total_Pop + White_Total_Pop, data = pdata_train, model = "pooling")

# M2: All Main Effects (Age + Sex + Race)
m_pooled <- plm(dem_vote_share_two_party ~ Age_0_Total_Pop + Age_1_Total_Pop + Age_2_Total_Pop + Age_4_Total_Pop + Age_5_Total_Pop + Female_Total_Pop + Black_Total_Pop + White_Total_Pop, data = pdata_train, model = "pooling")

```

```{r}

# BASE MODELS: COMPARISON

# Summary Statistics
summary(m_int)
summary(m_age)
summary(m_sex)
summary(m_race)
summary(m_pooled)

# F-Tests: Model Complexity
pFtest(m_age, m_int)
pFtest(m_pooled, m_age)
pFtest(m_pooled, m_sex)
pFtest(m_pooled, m_race) # Result for all: Complex models perform better

# R^2 Analysis
r2_values <- c(
  m_int = summary(m_int)$r.squared,
  m_age = summary(m_age)$r.squared,
  m_sex = summary(m_sex)$r.squared,
  m_race = summary(m_race)$r.squared,
  m_pooled = summary(m_pooled)$r.squared
)

r2_df <- data.frame(
  model = names(r2_values),
  r_squared = as.numeric(r2_values)
)

r2_adj_df <- r2_df[r2_df$model %in% c("m_int.adjrsq", "m_age.adjrsq", "m_sex.adjrsq", "m_race.adjrsq", "m_pooled.adjrsq"), ] %>% 
    mutate(across(where(is.numeric), ~ round(.x, 2)))
model_names <- c("Intercept Model", "Age Model", "Sex Model", "Race Model", "Age-Sex-Race Model")
r2_adj_df$model <- model_names
r2_adj_df$model <- factor(r2_adj_df$model, levels = r2_adj_df$model)

r2_base_models <- ggplot(r2_adj_df, aes(x = model, y = r_squared)) +
  geom_point() +
  labs(x = "Model", y = "Adjusted R Squared", title = "Adjusted R Squared by Model Type - Base Models") +
  theme_minimal()

print(r2_base_models)
print(r2_adj_df %>% kable())
print(summary(m_pooled)) # Model of interest (age-sex-race model)

```

```{r}

# MODEL SEQUENCE: FIXED & RANDOM EFFECTS

model <- dem_vote_share_two_party ~ Age_0_Total_Pop + Age_1_Total_Pop + Age_2_Total_Pop + Age_4_Total_Pop + Age_5_Total_Pop + Female_Total_Pop + Black_Total_Pop + White_Total_Pop

# M3A: Year FE
m_year_fe <- plm(model, data = pdata_train, model = "within", effect = "time")
 
# M3B: County FE
m_county_fe <- plm(model, data = pdata_train, model = "within", effect = "individual")

# M4: Two-Way FE
m_tw_fe <- plm(model, data = pdata_train, model = "within", effect = "twoways")

# M5: RE
m_re <- plm(model, data = pdata_train, model = "random")

```

```{r}

# MODEL TESTING

# Pooled OLS can have much higher R^2 because it falsely attributes fixed traits such as county partisanship to the included variables, whereas TWFE drops that explanatory power

# F-Test (Fixed Effects vs. OLS)
pFtest(m_year_fe, m_pooled) # Prefer FE
pFtest(m_county_fe, m_pooled) # Prefer FE

# Breusch-Pagan Lagrange Multiplier Test (Random Effects vs. OLS)
plmtest(m_pooled, type = "bp") # Prefer RE

# Hausman Test (Fixed vs. Random Effects)
phtest(m_year_fe, m_re) # Prefer FE
phtest(m_county_fe, m_re) # Prefer FE

summary(m_tw_fe)
summary(m_county_fe)
summary(m_year_fe)

```

